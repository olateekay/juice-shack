# .gitlab-ci.yml
# This file sets up a CI/CD pipeline for the OWASP Juice Shop project - a Node.js application.
# The pipeline consists of three stages: 'cache', 'test', and 'build'. Each stage addresses
# specific concerns such as speeding up dependency installation, running tests, and containerizing the application.

# TOP-LEVEL VARIABLES
# Global variables are defined here so that they can be reused in multiple jobs,
# helping avoid hardcoding values in different parts of the pipeline.
variables:
  IMAGE_NAME: dkhanduke/demo-app     # The Docker Hub repository name where the Docker image will be pushed.
  IMAGE_TAG: juice-shop-1.1           # The version tag for the Docker image (example version identifier).

# STAGES
# The stages are executed in a strict order. If a stage fails (example cache or test),
# the following stages will not run.
stages:
  - cache  
  # First stage: Caches Yarn dependencies.
  - test   
  # Second stage: Runs tests on the code base. Logic - we built this out first.
  - build 
  # Third stage: Builds the Docker image and pushes it to the registry.

# STAGE 1: CREATE_CACHE
# This job installs Yarn dependencies and caches them for later reuse. Caching improves
# pipeline speed by avoiding repeated downloads.
create_cache:
  image: node:18-bullseye
  # Using the official Node.js image that comes with Yarn pre-installed.
  
  stage: cache
  # This job is part of the 'cache' stage.
  
  script:
    - yarn install
    # Reads the package.json file and installs required Node.js libraries into node_modules.
  
  cache:
    key:
      files:
        - yarn.lock
        # The yarn.lock file ensures that the exact versions of dependencies are used.
        # If the file changes, a new cache is generated.
    paths:
      - node_modules/   # The folder where all dependencies are stored.
      - yarn.lock       # Cache the lock file to maintain version consistency.
      - .yarn          # Cache the .yarn folder, which can include extra caching or configuration data.
    policy: pull-push
    # The pull-push policy means the job will first try to reuse an existing cache and then update it if any changes are detected.

# STAGE 2: YARN_TEST
# This job uses the cached dependencies and runs the application's tests.
yarn_test:
  image: node:18-bullseye
  # Using the same Node.js + Yarn image for consistency.

  stage: test
  # This job runs in the 'test' stage.
  
  script:
    - yarn install
    # Ensure dependencies are present. Yarn will usually skip re-downloading if node_modules already exists.
    - yarn test
    # Execute the test suite defined for the project (could be unit tests, integration tests, etc.).
  
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/  # Reuse the cached node_modules to speed up dependency verification.
      - yarn.lock      # Include the lock file from the cache.
      - .yarn         # Reuse any cached data in the .yarn folder.
    policy: pull
    # The pull policy indicates that this job should only fetch the existing cache without updating it.

# STAGE 3: BUILD_IMAGE
# This job builds a Docker image from the project and pushes it to a Docker registry (example Docker Hub).
build_image:
  image: docker:24
  # Using the Docker CLI image to run Docker commands such as 'docker build' and 'docker push'.

  stage: build
  # This job is part of the 'build' stage.
  
  services:
    - docker:24-dind
    # Docker-in-Docker (dind) provides a Docker daemon within the container, allowing the job to build and push images.
  
  # Note: In a production environment, credentials must be secured using GitLab CI/CD variables. This is only being done for the sake of the project. 
  variables:
    DOCKER_PASS: Blingo123   # This should normally be stored as a masked / protected variable.
    DOCKER_USER: dkhanduke

  before_script:
    # Securely log in to Docker using the password provided via standard input. This avoids exposing the password in logs.
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

  script:
    # Build the Docker image using the Dockerfile in the current directory.
    # The -t flag tags the image with a combination of IMAGE_NAME and IMAGE_TAG.
    # Example tag: dkhanduke/demo-app:juice-shop-1.1
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    # Push the built image to the Docker registry (example Docker Hub).
    - docker push $IMAGE_NAME:$IMAGE_TAG
